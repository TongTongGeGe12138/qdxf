import{e as re,k as d,y as ne,o as ie,n as se,$ as Se,t as g,z as H,A as v,L as Ee,h as z,H as $,r as U,w as Ie,a7 as ze,G as X,u as J,a8 as Be,g as f,E as i,x as I,I as x,F as N,a0 as Re,a1 as j,f as Ve,B as Ge}from"./vendor-D1U3vd9f.js";import{i as V}from"./index-Bz-KOdQ0.js";import{g as xe,a as $e,b as le,c as oe,d as Ue}from"./dict-BkvdzF-A.js";import{E as F,g as ce,a as Xe,f as Ne}from"./EngineContext-ppOk6u20.js";import{_ as de}from"./_plugin-vue_export-helper-DlAUqK2U.js";const Oe={class:"cad-header"},We={class:"title"},Ze={id:"ibp-2d-container","element-loading-text":"CAD文件加载中..."},je=re({__name:"CadViewer",props:{visible:{type:Boolean},fileId:{},fileName:{}},emits:["update:visible"],setup(Q,{emit:B}){const R=Q,w=B,_=d(!1);ne(()=>R.visible,r=>{r?p():y()});const p=async()=>{if(!R.fileId){i.error("文件ID不存在");return}_.value=!0;try{const r=await ce(R.fileId);if(r.code!==200||!r.data.url){i.error("获取文件信息失败");return}await se();const D=document.getElementById("ibp-2d-container");if(!D){i.error("CAD容器不存在");return}F.AttachContainer(D);try{const m=new Promise((P,T)=>{setTimeout(()=>T(new Error("请求超时")),3e4)}),k=Xe({DwgUrl:r.data.url}),A=await Promise.race([k,m]);if(A.Code===0){const P=T=>{if(T.isComplete===!1){i.error("该路径无法打开"),_.value=!1;return}T.isComplete===!0&&(F.ViewManager.ZoomToFit(),F.LoadManager.removeEventListener("finish",P),_.value=!1,F.init())};F.LoadManager.addEventListener("finish",P),F.LoadManager.LoadModel({url:A.Data,type:"p2d"})}else console.error("P2D接口返回错误:",A),i.error(A.Msg||"获取P2D文件失败"),A.Msg==="dwg地址错误"&&r.data.url&&(i.info("尝试直接加载DWG文件..."),F.LoadManager.LoadModel({url:r.data.url,type:"dwg"}))}catch(m){console.error("P2D文件加载失败:",m),m instanceof Error&&m.message==="请求超时"?i.error("P2D文件加载超时，请稍后重试"):i.error("获取P2D文件失败，请稍后重试");try{i.info("尝试直接加载DWG文件..."),F.LoadManager.LoadModel({url:r.data.url,type:"dwg"})}catch(k){console.error("DWG文件加载也失败:",k),i.error("无法加载CAD文件，请检查文件是否有效"),_.value=!1}}}catch(r){console.error("打开CAD查看器失败:",r),i.error("打开CAD查看器失败"),_.value=!1}},y=()=>{_.value=!1,F.Container&&(F.Container.style.display="none"),w("update:visible",!1)},S=()=>{y()};return ie(()=>{se(()=>{F.init()})}),Se(()=>{F.Container&&(F.Container.style.display="none")}),(r,D)=>{const m=U("el-icon"),k=ze("loading");return r.visible?(f(),g("div",{key:0,class:"cad-viewer-overlay",onClick:S},[v("div",{class:"cad-viewer",onClick:D[0]||(D[0]=X(()=>{},["stop"]))},[v("div",Oe,[v("span",We,"CAD查看器 - "+$(r.fileName),1),z(m,{class:"close-btn",onClick:y},{default:Ie(()=>[z(J(Be))]),_:1})]),Ee(v("div",Ze,null,512),[[k,_.value]])])])):H("",!0)}}}),He=de(je,[["__scopeId","data-v-99d971d1"]]),Je={class:"knowledge-base-container"},Qe={class:"main-panel"},qe={class:"controls-header"},Ke={class:"main-tabs"},Ye=["onClick"],ea={class:"filter-section"},aa={class:"filter-title"},ta={class:"tags"},sa=["onClick"],la={key:0,class:"loading-container"},oa={key:1,class:"empty-container"},ra={key:2,class:"file-list"},na=["onClick","onDblclick"],ia={class:"file-icon"},ca=["src","alt"],da=["src","alt"],ua={class:"file-info"},va={class:"file-name"},fa={key:0,class:"file-actions"},ga=["onClick"],pa=["onClick"],ya={key:3,class:"pagination-container"},ma=re({__name:"index",setup(Q){Ge(a=>({"201e6ac8":Fe.value,"3aef7adc":be.value,"28e22c31":Ae.value,"5c879404":ke.value,c807e07e:we.value,cf3bbcc4:De.value}));const B=d(0),R=d(["通用规范","通用图库","供应商图库","样例模板"]),w=d(""),_=d(!1),p=d([]),y=d(1),S=d(20),r=d(0),D=d(null),m=d(""),k=d(""),A=d(!1),P=d(""),T=d([]),E=d([]),ue=d(0),l=d([{title:"标准分类",activeFilter:"",filters:[]},{title:"规范分类",activeFilter:"全部",filters:["全部"]}]),O=d(!1),W=d(null),q=I(()=>l.value[1].activeFilter&&l.value[1].activeFilter!=="全部"||A.value?[{id:"back",name:"返回上级",type:"back",size:0,updateTime:"",thumbUrl:void 0,contentType:void 0},...p.value]:p.value),L=async()=>{var a,e,n,h,M,c,C,G,s;_.value=!0;try{let t;const b={all:!1,search:w.value,page:y.value,pageSize:S.value};if(l.value[0].activeFilter&&(!l.value[1].activeFilter||l.value[1].activeFilter==="全部")){console.log("显示二级分类作为文件夹"),console.log("二级分类数据:",E.value);let u=E.value.filter(o=>o.name!=="全部");w.value.trim()&&(u=u.filter(o=>o.name.toLowerCase().includes(w.value.toLowerCase()))),p.value=u.map((o,Me)=>(console.log(`处理第${Me}项:`,o),{id:o.id||o.folderId||o._id,name:o.name||o.title||o.folderName||"未命名文件夹",type:"folder",size:o.size||0,updateTime:o.updateTime||o.createTime||o.updatedAt||new Date().toISOString()})),r.value=u.length}else if(l.value[1].activeFilter&&l.value[1].activeFilter!=="全部")try{const u=E.value.find(o=>o.name===l.value[1].activeFilter);if(!u){console.error("未找到对应的二级分类:",l.value[1].activeFilter),p.value=[],r.value=0;return}if(t=await le({id:u.id,...b}),t&&t.code===200){console.log("获取二级分类文件数据:",t.data);let o=[];(a=t.data)!=null&&a.data&&Array.isArray(t.data.data)?o=t.data.data:(e=t.data)!=null&&e.list&&Array.isArray(t.data.list)?o=t.data.list:Array.isArray(t.data)&&(o=t.data),Array.isArray(o)?(p.value=o,r.value=((n=t.data)==null?void 0:n.total)||o.length):(console.error("文件数据不是数组:",o),p.value=[],r.value=0)}}catch(u){console.error("获取二级分类文件失败:",u);try{if(t=await oe({category:m.value,...b}),t&&t.code===200){console.log("获取二级分类文件数据(备用方法):",t.data);let o=[];(h=t.data)!=null&&h.data&&Array.isArray(t.data.data)?o=t.data.data:(M=t.data)!=null&&M.list&&Array.isArray(t.data.list)?o=t.data.list:Array.isArray(t.data)&&(o=t.data),Array.isArray(o)?(p.value=o,r.value=((c=t.data)==null?void 0:c.total)||o.length):(console.error("备用方法文件数据不是数组:",o),p.value=[],r.value=0)}}catch(o){console.error("备用方法也失败:",o),i.error("获取文件数据失败")}}else if(t=await oe({category:m.value,...b}),t&&t.code===200){console.log("获取顶级分类文件数据:",t.data);let u=[];(C=t.data)!=null&&C.data&&Array.isArray(t.data.data)?u=t.data.data:(G=t.data)!=null&&G.list&&Array.isArray(t.data.list)?u=t.data.list:Array.isArray(t.data)&&(u=t.data),Array.isArray(u)?(p.value=u,r.value=((s=t.data)==null?void 0:s.total)||u.length):(console.error("顶级分类文件数据不是数组:",u),p.value=[],r.value=0)}t&&t.code!==200&&i.error(t.message||"获取文件列表失败")}catch(t){console.error("获取文件列表失败:",t),i.error("获取文件列表失败")}finally{_.value=!1}},ve=a=>{B.value=a,m.value=K(a),k.value="",y.value=1,l.value[0].activeFilter="",l.value[1].activeFilter="",A.value=!1,P.value="",ae()},K=a=>["通用规范","通用图库","供应商图库","样例模板"][a]||"通用规范",fe=(a,e)=>{console.log(a,e,9999999),l.value[a].activeFilter=e,A.value=!1,P.value="",a===0?(k.value=e,l.value[1].activeFilter="",Z(e)):a===1&&(e==="全部"?(k.value=l.value[0].activeFilter,Z(l.value[0].activeFilter)):(k.value=e,L())),y.value=1,(a!==1||e!=="全部")&&L()},ge=()=>{console.log("执行搜索，关键词:",w.value),y.value=1,L()},pe=a=>{console.log("点击文件:",a),D.value=a},ye=async a=>{if(console.log("双击文件:",a),a.type==="back"){console.log("返回上级"),Te();return}if(a.type==="folder"||a.contentType===0){console.log("进入文件夹:",a.name);const e=E.value.find(n=>n.name===a.name);e?(l.value[1].activeFilter=e.name,L()):(console.log("使用文件夹ID获取内容:",a.id),Pe(a.id));return}Y(a)},me=()=>{D.value=null},Y=async a=>{var e;try{if(a.contentType===141||((e=a.type)==null?void 0:e.toLowerCase())==="dwg")W.value=a,O.value=!0;else{const n=await ce(a.id);n.code===200&&n.data.url?window.open(n.data.url,"_blank"):i.warning("获取文件链接失败或链接不存在")}}catch(n){console.error("获取文件链接失败:",n),i.error("获取文件链接失败")}},_e=a=>{S.value=a,y.value=1,L()},he=a=>{y.value=a,L()},ee=(a,e)=>a?a==="folder"||e===0?"/src/assets/file-icons/folder-large.svg":e?{41:"/src/assets/file-icons/PDF.png",42:"/src/assets/file-icons/DOC.png",43:"/src/assets/file-icons/XLSX.png",45:"/src/assets/file-icons/PPT.png",61:"/src/assets/file-icons/JPG.png",62:"/src/assets/file-icons/PNG.png",141:"/src/assets/file-icons/DWG.png",142:"/src/assets/file-icons/DXF.png",161:"/src/assets/file-icons/RVT.png",162:"/src/assets/file-icons/RFA.png",163:"/src/assets/file-icons/RTE.png",164:"/src/assets/file-icons/IFG.png",121:"/src/assets/file-icons/ZIP.png",122:"/src/assets/file-icons/RAR.png",21:"/src/assets/file-icons/TXT.png"}[e]||"/src/assets/file-icons/fileSvg.svg":{pdf:"/src/assets/file-icons/PDF.png",doc:"/src/assets/file-icons/DOC.png",docx:"/src/assets/file-icons/DOCX.png",xlsx:"/src/assets/file-icons/XLSX.png",pptx:"/src/assets/file-icons/PPTX.png",dwg:"/src/assets/file-icons/DWG.png",dxf:"/src/assets/file-icons/DXF.png",jpg:"/src/assets/file-icons/JPG.png",png:"/src/assets/file-icons/PNG.png",zip:"/src/assets/file-icons/ZIP.png",rar:"/src/assets/file-icons/RAR.png"}[a.toLowerCase()]||"/src/assets/file-icons/fileSvg.svg":"/src/assets/file-icons/fileSvg.svg",Ce=a=>{const e=a.target,n=p.value.find(h=>h.thumbUrl===e.src);n&&(e.src=ee(n.type||"",n.contentType))};ne(w,()=>{clearTimeout(window.searchTimer),window.searchTimer=setTimeout(()=>{y.value=1,ge()},500)}),ie(()=>{m.value=K(B.value),ae()});const Fe=I(()=>V.value?"#EDEDED":"#13343C"),Ae=I(()=>V.value?"#A1A1A1":"#13343C"),be=I(()=>V.value?"rgba(231, 231, 224, 0.2)":"rgba(0, 0, 0, 0.1)"),ke=I(()=>V.value?"#0A0A0A":"#faf9f5"),we=I(()=>V.value?"#2b2b2b":"#f0f0f0"),De=I(()=>(V.value,"#ff9900")),ae=async()=>{var a;try{const{data:e,code:n}=await xe(m.value);if(n===200){console.log("获取一级分类数据:",e),T.value=e,te();const h=(a=e[ue.value])==null?void 0:a.name;h&&await Z(h)}}catch(e){console.log("获取一级分类失败:",e)}},Z=async a=>{try{const e=await $e({category:m.value,lv1:a});e.code===200&&(console.log("获取二级分类数据:",e.data),E.value=e.data,te(),L())}catch(e){console.log("获取二级分类失败:",e)}},te=()=>{const a=R.value[B.value];a==="通用规范"?(l.value[0].title="标准分类",l.value[1].title="规范分类"):a==="通用图库"?(l.value[0].title="专业分类",l.value[1].title="构件分类"):a==="供应商图库"?(l.value[0].title="材料设备分类",l.value[1].title="供应商列表"):a==="样例模板"&&(l.value[0].title="专业分类",l.value[1].title="建筑类别"),T.value.length>0&&(l.value[0].filters=T.value.map(e=>e.name),l.value[0].activeFilter||(l.value[0].activeFilter=T.value[0].name,console.log("自动选择第一个一级分类:",l.value[0].activeFilter))),E.value.length>0?(l.value[1].filters=["全部",...E.value.map(e=>e.name)],l.value[1].activeFilter||(l.value[1].activeFilter="全部",console.log('自动选择二级分类"全部"'))):(l.value[1].filters=["全部"],l.value[1].activeFilter||(l.value[1].activeFilter="全部",console.log('自动选择二级分类"全部"')))},Te=()=>{A.value?(A.value=!1,P.value="",L()):(l.value[1].activeFilter="",k.value="",y.value=1,L())},Le=async a=>{try{const e=await Ue(a);e.code===200?i.success("已添加到我的资源"):i.error(e.message||"添加失败")}catch(e){console.error("添加失败:",e),i.error("添加失败")}},Pe=async a=>{var e,n,h;_.value=!0,A.value=!0,P.value=a;try{const M={all:!1,search:w.value,page:y.value,pageSize:S.value},c=await le({id:a,...M});if(c&&c.code===200){console.log("获取文件夹内容:",c.data);let C=[];(e=c.data)!=null&&e.data&&Array.isArray(c.data.data)?C=c.data.data:(n=c.data)!=null&&n.list&&Array.isArray(c.data.list)?C=c.data.list:Array.isArray(c.data)&&(C=c.data),Array.isArray(C)?(p.value=C,r.value=((h=c.data)==null?void 0:h.total)||C.length):(console.error("文件夹数据不是数组:",C),p.value=[],r.value=0)}else i.error((c==null?void 0:c.message)||"获取文件夹内容失败")}catch(M){console.error("获取文件夹内容失败:",M),i.error("获取文件夹内容失败")}finally{_.value=!1}};return(a,e)=>{var C,G;const n=U("el-input"),h=U("el-loading-spinner"),M=U("el-empty"),c=U("el-pagination");return f(),g(x,null,[v("div",Je,[e[5]||(e[5]=v("div",{class:"page-title"},"行业资源",-1)),v("div",Qe,[v("div",qe,[v("div",Ke,[(f(!0),g(x,null,N(R.value,(s,t)=>(f(),g("div",{key:t,class:j(["tab",{active:B.value===t}]),onClick:b=>ve(t)},$(s),11,Ye))),128))]),z(n,{modelValue:w.value,"onUpdate:modelValue":e[0]||(e[0]=s=>w.value=s),placeholder:"搜索","prefix-icon":J(Re),class:"search-input",clearable:""},null,8,["modelValue","prefix-icon"])]),v("div",ea,[(f(!0),g(x,null,N(l.value,(s,t)=>(f(),g("div",{key:t,class:"filter-group"},[v("div",aa,$(s.title),1),v("div",ta,[(f(!0),g(x,null,N(s.filters,(b,u)=>(f(),g("div",{key:u,class:j(["tag",{active:s.activeFilter===b}]),onClick:o=>fe(t,b)},$(b),11,sa))),128))])]))),128))]),v("div",{class:"content-area",onClick:me},[_.value?(f(),g("div",la,[z(h),e[4]||(e[4]=v("p",null,"加载中...",-1))])):q.value.length===0?(f(),g("div",oa,[z(M,{description:"暂无数据"})])):(f(),g("div",ra,[(f(!0),g(x,null,N(q.value,s=>{var t;return f(),g("div",{key:s.id,class:j(["file-item",{"is-selected":((t=D.value)==null?void 0:t.id)===s.id}]),onClick:X(b=>pe(s),["stop"]),onDblclick:X(b=>ye(s),["stop"])},[v("div",ia,[s.type==="back"||s.type==="folder"||s.contentType===0?(f(),Ve(J(Ne),{key:0})):s.thumbUrl&&s.type!=="folder"&&s.contentType!==0?(f(),g("img",{key:1,src:s.thumbUrl,alt:s.name,onError:Ce},null,40,ca)):(f(),g("img",{key:2,src:ee(s.type||"",s.contentType),alt:s.type||"file"},null,8,da))]),v("div",ua,[v("div",va,$(s.name||"未命名文件"),1)]),s.type!=="folder"&&s.type!=="back"&&s.contentType!==0?(f(),g("div",fa,[v("button",{class:"action-btn",onClick:X(b=>Y(s),["stop"])},"查看",8,ga),v("button",{class:"action-btn",onClick:X(b=>Le(s.id),["stop"])},"收藏资源",8,pa)])):H("",!0)],42,na)}),128))])),p.value.length>0?(f(),g("div",ya,[z(c,{"current-page":y.value,"onUpdate:currentPage":e[1]||(e[1]=s=>y.value=s),"page-size":S.value,"onUpdate:pageSize":e[2]||(e[2]=s=>S.value=s),"page-sizes":[10,20,50,100],total:r.value,layout:"total, sizes, prev, pager, next, jumper",onSizeChange:_e,onCurrentChange:he},null,8,["current-page","page-size","total"])])):H("",!0)])])]),z(He,{visible:O.value,"onUpdate:visible":e[3]||(e[3]=s=>O.value=s),"file-id":((C=W.value)==null?void 0:C.id)||"","file-name":((G=W.value)==null?void 0:G.name)||""},null,8,["visible","file-id","file-name"])],64)}}}),ba=de(ma,[["__scopeId","data-v-b3554c05"]]);export{ba as default};
